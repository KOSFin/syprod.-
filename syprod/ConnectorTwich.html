<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Chat Mirror</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #f1f1f1;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }

        #app {
            text-align: center;
            width: 90%;
            max-width: 600px;
        }

        input, button {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
        }

        #chat {
            margin-top: 20px;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
        }

        .message {
            margin: 5px 0;
        }

        .username {
            color: #1db954;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Twitch Chat Mirror</h1>
        <button id="auth">Login with Twitch</button>
        <div id="chat"></div>
    </div>

    <script>
        const authButton = document.getElementById('auth');
        const chatContainer = document.getElementById('chat');
        let username = '';
        let accessToken = '';

        const clientId = 'pxie3yypaf51ctb0gmvz7m76fq4z0c'; // Your Twitch client ID
        const redirectUri = 'https://syprod.ru/ConnectorTwich.html';

        authButton.addEventListener('click', () => {
            const authUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=chat:read`;
            window.location.href = authUrl;
        });

        // Extract access token from URL hash
        const hash = window.location.hash;
        if (hash.includes('access_token')) {
            const params = new URLSearchParams(hash.substring(1));
            accessToken = params.get('access_token');

            if (accessToken) {
                chatContainer.innerHTML = '<p>Connected! Fetching chat...</p>';
                fetchChat();
            }
        }

        async function fetchChat() {
            try {
                const headers = {
                    'Authorization': `Bearer ${accessToken}`,
                    'Client-Id': clientId
                };

                // Fetch user information
                const response = await axios.get('https://api.twitch.tv/helix/users', { headers });
                const user = response.data.data[0];
                username = user.login;

                chatContainer.innerHTML = `<p>Connected to ${username}'s chat!</p>`;

                // Use Twitch WebSocket for chat connection
                connectToChat(user.id);

            } catch (error) {
                console.error('Error fetching chat:', error);
                chatContainer.innerHTML = '<p>Failed to fetch chat. Check console for details.</p>';
            }
        }

        // WebSocket to listen for Twitch chat messages (using Twitch IRC)
        function connectToChat(userId) {
            const socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

            socket.onopen = () => {
                socket.send(`PASS oauth:${accessToken}`);
                socket.send(`NICK ${username}`);
                socket.send(`JOIN #${username}`); // Join the chat room

                chatContainer.innerHTML += `<p>Joined chat room for ${username}</p>`;
            };

            socket.onmessage = (event) => {
                const message = event.data;
                if (message.includes('PRIVMSG')) {
                    const messageParts = message.split(' :');
                    const msgText = messageParts[1];
                    const username = messageParts[0].split('!')[0].substring(1); // Extract username
                    displayMessage(username, msgText);
                }
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            socket.onclose = () => {
                console.log('WebSocket closed');
            };
        }

        // Display chat message
        function displayMessage(username, message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.innerHTML = `<span class="username">${username}:</span> ${message}`;
            chatContainer.appendChild(messageElement);
            chatContainer.scrollTop = chatContainer.scrollHeight; // Auto-scroll to the bottom
        }
    </script>
</body>
</html>
