<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Chat Mirror</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #f1f1f1;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #app {
            text-align: center;
            width: 90%;
            max-width: 600px;
        }
        input, button {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
        }
        #chat {
            margin-top: 20px;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
        }
        .message {
            margin: 5px 0;
        }
        .username {
            color: #1db954;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div id="app">
        <h1>Twitch Chat Mirror</h1>
        <button id="auth">Login with Twitch</button>
        <div id="chat"></div>
    </div>

    <script>
        const authButton = document.getElementById('auth');
        const chatContainer = document.getElementById('chat');
        let username = '';
        let accessToken = '';

        const clientId = 'pxie3yypaf51ctb0gmvz7m76fq4z0c'; // Replace with your Twitch client ID
        const redirectUri = 'https://syprod.ru/ConnectorTwich.html';

        // Trigger OAuth2 login process
        authButton.addEventListener('click', () => {
            const authUrl = `https://id.twitch.tv/oauth2/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=chat:read`;
            window.location.href = authUrl;
        });

        // Extract access token from URL
        const hash = window.location.hash;
        if (hash.includes('access_token')) {
            const params = new URLSearchParams(hash.substring(1));
            accessToken = params.get('access_token');

            if (accessToken) {
                chatContainer.innerHTML = '<p>Connected! Fetching chat...</p>';
                fetchChat();
            }
        }

        // Fetch chat data using access token
        async function fetchChat() {
            try {
                const headers = {
                    'Authorization': `Bearer ${accessToken}`,
                    'Client-Id': clientId
                };

                const response = await axios.get('https://api.twitch.tv/helix/users', { headers });
                const user = response.data.data[0];
                username = user.login;

                chatContainer.innerHTML = `<p>Connected to ${username}'s chat!</p>`;
                fetchChatMessages(); // Start receiving chat messages
            } catch (error) {
                console.error('Error fetching user:', error);
                chatContainer.innerHTML = '<p>Failed to fetch user. Check console for details.</p>';
            }
        }

        // Fetch chat messages - placeholder logic
        async function fetchChatMessages() {
            // Example using the Twitch API to get stream data, as real-time messages via EventSub require Webhooks/WebSockets which can't be handled client-side
            try {
                const headers = {
                    'Authorization': `Bearer ${accessToken}`,
                    'Client-Id': clientId
                };

                // Fetching stream information as an example
                const streamResponse = await axios.get(`https://api.twitch.tv/helix/streams?user_login=${username}`, { headers });

                if (streamResponse.data.data.length > 0) {
                    chatContainer.innerHTML += `<p>${username} is live! Watching...</p>`;
                } else {
                    chatContainer.innerHTML += `<p>${username} is offline.</p>`;
                }

                // Simulate chat messages being sent (since actual chat messages need webhook or socket)
                setTimeout(() => {
                    const message = `Test message in ${username}'s chat!`;
                    displayMessage('TwitchDev', message);
                }, 2000);
            } catch (error) {
                console.error('Error fetching chat:', error);
            }
        }

        // Display a chat message
        function displayMessage(username, message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.innerHTML = `<span class="username">${username}:</span> ${message}`;
            chatContainer.appendChild(messageDiv);
        }
    </script>
</body>
</html>
